<!doctype html>
<html lang="es">
<head>
  <!-- =========================================================
       BLOQUE 1/8 — HEAD / META / OFFICE.JS
       ========================================================= -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEPROINCA-IA</title>

  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <!-- =========================================================
       BLOQUE 2/8 — CSS (UI / THEME)
       ========================================================= -->
  <style>
    :root{
      --blue1:#1f4f86;
      --blue2:#163d69;
      --ink:#0f172a;
      --muted:#6b7280;
      --b:#e5e7eb;
      --bg:#ffffff;
      --card:#ffffff;

      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#ef4444;
      --btn:#0b3a64;
      --btn2:#0f4b82;

      --shadow: 0 6px 18px rgba(15,23,42,.08);
      --radius: 14px;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Segoe UI", Inter, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    .header{
      background: linear-gradient(180deg, var(--blue1), var(--blue2));
      color:#fff;
      padding: 14px 14px 12px;
      position: sticky;
      top:0;
      z-index: 5;
      box-shadow: 0 4px 18px rgba(0,0,0,.18);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.5px;
      font-size:18px;
    }
    .brand .logo{
      width:22px;
      height:22px;
      border:2px solid rgba(255,255,255,.9);
      border-left-color: transparent;
      transform: rotate(45deg);
      border-radius: 4px;
    }
    .sub{
      opacity:.92;
      font-size:12.5px;
      margin-top:4px;
      letter-spacing:.2px;
    }

    .wrap{
      padding: 12px 12px 18px;
      max-width: 520px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--b);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      margin-bottom: 12px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .label{
      font-size:12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }

    input, textarea, select{
      width:100%;
      box-sizing:border-box;
      padding: 10px 11px;
      border: 1px solid var(--b);
      border-radius: 12px;
      font-size:14px;
      outline: none;
      background:#fff;
    }
    textarea{ min-height: 82px; resize: vertical; }

    select{
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #334155 50%),
        linear-gradient(135deg, #334155 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 12px) calc(50% - 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 34px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.12);
      color: #fff;
      user-select:none;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:#9ca3af;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.35);
    }
    .dot.green{ background: #22c55e; }
    .dot.red{ background: #ef4444; }
    .dot.neutral{ background:#9ca3af; }

    .btn{
      width:100%;
      border:0;
      border-radius: 14px;
      padding: 12px 12px;
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color:#fff;
      font-size: 15px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(11,58,100,.18);
    }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .btnGhost{
      border:1px solid var(--b);
      background:#fff;
      color:#111827;
      font-weight:700;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      width:100%;
    }
    .btnGhost:disabled{ opacity:.6; cursor:not-allowed; }

    .divider{
      height:1px;
      background: var(--b);
      margin: 10px 0;
    }

    .kvs{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
      font-size: 13px;
      align-items:center;
    }
    .k{ color: var(--muted); font-weight:700; }
    .v{ color: #111827; font-weight:600; word-break: break-word; overflow-wrap:anywhere; }

    .log{
      background:#f6f8fa;
      border-radius: 12px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 220px;
      overflow:auto;
      border: 1px solid #eef2f7;
    }

    .ok{ color:#065f46; font-weight:900; }
    .bad{ color:#991b1b; font-weight:900; }

    .modeRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toggle{
      display:flex;
      gap:0;
      border:1px solid var(--b);
      border-radius: 999px;
      overflow:hidden;
      background:#fff;
    }
    .toggle button{
      border:0;
      background:transparent;
      padding: 7px 10px;
      font-weight:800;
      cursor:pointer;
      color:#334155;
      font-size: 12.5px;
    }
    .toggle button.active{
      background:#eaf2ff;
      color:#0b3a64;
    }

    .hint{
      font-size:12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .collapseHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .logHidden{
      display:none;
    }
  </style>
</head>

<body>
  <!-- =========================================================
       BLOQUE 3/8 — HTML UI (HEADER / ESTADO)
       ========================================================= -->
  <div class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>SEPROINCA-IA</div>
    </div>
    <div class="sub">Asistente Técnico Estructural</div>
    <div class="row" style="margin-top:10px; justify-content:space-between;">
      <div class="chip" id="hostChip">
        <span class="dot" id="hostDot"></span>
        <span id="hostText">host: ?</span>
      </div>

      <div class="chip" id="tokenStateChip">
        <span class="dot neutral" id="stateDot"></span>
        <span id="stateText">Estado: a la espera de petición</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- =========================================================
         BLOQUE 4/8 — HTML UI (TOKEN / MODO)
         ========================================================= -->
    <div class="card">
      <div class="modeRow">
        <div style="font-weight:900;">Modo</div>
        <div class="toggle" role="tablist" aria-label="Modo">
          <button id="btnModeLearn" class="active" type="button">Aprendizaje</button>
          <button id="btnModeProd" type="button">Producción</button>
        </div>
      </div>

      <div class="label">Token</div>
      <input id="token" type="text" placeholder="Pega aquí tu token (se recordará automáticamente)" />
      <div class="hint">Tip: el token se guarda localmente en tu Excel y queda editable por si deseas cambiarlo.</div>

      <input id="apiUrl" type="text" style="display:none" />
    </div>

    <!-- =========================================================
         BLOQUE 5/8 — HTML UI (SELECCIÓN)
         ========================================================= -->
    <div class="card">
      <div style="font-weight:900; margin-bottom:8px;">Rango seleccionado</div>

      <div class="kvs">
        <div class="k">Dirección</div><div class="v" id="rangeAddr">—</div>
        <div class="k">Contenido</div><div class="v" id="rangeCells">—</div>
      </div>

      <div class="divider"></div>

      <button class="btnGhost" id="btnUseSelection" type="button">Usar selección actual</button>

      <div class="label" style="margin-top:10px;">Selección (texto)</div>
      <textarea id="selectionText" placeholder="Aquí se cargará la selección actual..."></textarea>
      <div class="hint">
        Para Analizar/Redactar/Revisar: usa la selección.
        <br>Para <b>Barras</b>: no necesitas selección (lee nombres en Excel).
      </div>
    </div>

    <!-- =========================================================
         BLOQUE 6/8 — HTML UI (ACCIÓN / EJECUTAR)
         ========================================================= -->
    <div class="card">
      <div style="font-weight:900; margin-bottom:8px;">¿Qué quieres hacer?</div>

      <div class="label" style="margin-top:0;">Acción</div>
      <select id="actionSelect">
        <option value="Analizar">Analizar — Explica y resume resultados</option>
        <option value="Redactar">Redactar — Genera texto técnico</option>
        <option value="Revisar">Revisar — Detecta errores e inconsistencias</option>
        <option value="Barras">Barras — Combinación de barras para As Requerido</option>
      </select>

      <div class="label">Instrucción (opcional)</div>
      <input id="instruction" type="text" placeholder="Escribe algo más específico..." />

      <div style="height:10px"></div>
      <button class="btn" id="btnExecute" type="button">Ejecutar</button>

      <div class="hint" id="miniHint">
        Flujo general: Selecciona celdas → Usar selección actual → (muévete a la celda destino) → Ejecutar
        <br>Modo Barras: Ejecutar (rellena celdas por nombre)
      </div>
    </div>

    <!-- =========================================================
         BLOQUE 7/8 — HTML UI (RESULTADO / LOG)
         ========================================================= -->
    <div class="card">
      <div style="font-weight:900; margin-bottom:8px;">Resultado</div>
      <div id="result" class="log">Listo. Abre una hoja, selecciona celdas y pulsa “Usar selección actual”.</div>
    </div>

    <div class="card">
      <div class="collapseHeader">
        <div style="font-weight:900;">Log</div>
        <div class="row" style="gap:8px;">
          <button class="btnGhost" id="btnPing" type="button" style="width:auto; padding:8px 10px;">Ping</button>
          <button class="btnGhost" id="btnToggleLog" type="button" style="width:auto; padding:8px 10px;">Ver log</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div id="logWrap" class="logHidden">
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       BLOQUE 8/8 — JAVASCRIPT (APP)
       Sub-bloques internos:
         8.1 DOM refs / config
         8.2 storage / logging / UI helpers
         8.3 Excel adapters (read selection, read/write names, paste cell)
         8.4 HTTP client (_fetchJson_)
         8.5 Barras helpers (format/pack to named cells)
         8.6 execute_ / ping_ / useSelection_
         8.7 Office.onReady wiring
       ========================================================= -->
<script>
(function(){
  const $ = (s) => document.querySelector(s);

  // ----------------------------
  // 8.1 — DOM refs / config
  // ----------------------------
  const elHostChip = $('#hostChip');
  const elHostDot  = $('#hostDot');
  const elHostText = $('#hostText');

  const elToken = $('#token');
  const elApiUrl = $('#apiUrl');

  const elStateDot  = $('#stateDot');
  const elStateText = $('#stateText');

  const elRangeAddr  = $('#rangeAddr');
  const elRangeCells = $('#rangeCells');

  const elSelText = $('#selectionText');
  const elInstr   = $('#instruction');
  const elAction  = $('#actionSelect');

  const elResult = $('#result');
  const elLog    = $('#log');

  const btnUseSelection = $('#btnUseSelection');
  const btnExecute = $('#btnExecute');
  const btnPing = $('#btnPing');

  const btnModeLearn = $('#btnModeLearn');
  const btnModeProd  = $('#btnModeProd');

  const btnToggleLog = $('#btnToggleLog');
  const elLogWrap = $('#logWrap');

  const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbwjODmMUtcK31iWBTUbEJcz8LnKZ8qUoCzBx7Sv16N8-jSSbAntQ8csTOicsozAfqRHcQ/exec";

  const API_TIMEOUT_MS_PING = 15000;
  const API_TIMEOUT_MS_POST = 35000;

  // ----------------------------
  // 8.2 — storage / logging / UI helpers
  // ----------------------------
  function storageAvailable_(){
    try{
      return (typeof Office !== 'undefined'
        && Office.Runtime
        && Office.Runtime.storage
        && typeof Office.Runtime.storage.getItem === 'function');
    }catch(e){ return false; }
  }

  async function storageGet_(key){
    if (storageAvailable_()){
      const v = await Office.Runtime.storage.getItem(key);
      return v || '';
    }
    return localStorage.getItem(key) || '';
  }

  async function storageSet_(key, value){
    if (storageAvailable_()){
      await Office.Runtime.storage.setItem(key, value);
      return;
    }
    localStorage.setItem(key, value);
  }

  async function storageDel_(key){
    if (storageAvailable_()){
      await Office.Runtime.storage.removeItem(key);
      return;
    }
    localStorage.removeItem(key);
  }

  function log(msg){
    const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    elLog.textContent = line + (elLog.textContent || '');
  }

  function escapeHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');
  }

  function showOK(text){
    elResult.innerHTML = `<span class="ok">OK</span>\n\n${escapeHtml(text || '')}`;
  }
  function showERR(text){
    elResult.innerHTML = `<span class="bad">ERROR</span>\n\n${escapeHtml(text || '')}`;
  }

  function setBusy(isBusy){
    [btnUseSelection, btnExecute, btnPing, btnModeLearn, btnModeProd, btnToggleLog].forEach(b => b && (b.disabled = !!isBusy));
    elToken.disabled = !!isBusy;
    elSelText.disabled = !!isBusy;
    elInstr.disabled = !!isBusy;
    elAction.disabled = !!isBusy;
  }

  let currentMode = 'Aprendizaje';
  function setMode(mode){
    currentMode = mode === 'Producción' ? 'Producción' : 'Aprendizaje';
    btnModeLearn.classList.toggle('active', currentMode === 'Aprendizaje');
    btnModeProd.classList.toggle('active', currentMode === 'Producción');
    log('Modo: ' + currentMode);
  }

  function setLogVisible_(visible){
    const v = !!visible;
    elLogWrap.classList.toggle('logHidden', !v);
    btnToggleLog.textContent = v ? 'Ocultar log' : 'Ver log';
  }

  // ----------------------------
  // 8.3 — Excel adapters
  // ----------------------------
  async function readSelectionExcel_(){
    if (typeof Excel === 'undefined' || !Excel.run){
      throw new Error('Excel API no disponible en este host.');
    }

    return await Excel.run(async (ctx) => {
      const range = ctx.workbook.getSelectedRange();
      range.load(['values','address','rowCount','columnCount']);
      await ctx.sync();

      const addr = range.address || '—';
      const rows = range.rowCount || 0;
      const cols = range.columnCount || 0;

      const values = range.values || [];
      const text = (values && Array.isArray(values) && values.length)
        ? values.map(r => (r||[]).map(v => String(v ?? '')).join('\t')).join('\n').trim()
        : '';

      return { addr, rows, cols, text };
    });
  }

  function updateRangeInfo_(addr, rows, cols){
    elRangeAddr.textContent = addr || '—';
    elRangeCells.textContent = (rows && cols) ? `${rows} × ${cols} (${rows*cols} celdas)` : '—';
  }

  async function writeResultToActiveCell_(text){
    try{
      if (typeof Excel === 'undefined' || !Excel.run) return;

      const out = String(text || '').trim();
      if (!out) return;

      await Excel.run(async (ctx) => {
        const cell = ctx.workbook.getActiveCell();
        cell.values = [[out]];
        cell.format.wrapText = true;
        cell.format.autofitRows();
        cell.format.autofitColumns();
        await ctx.sync();
      });

      log('Resultado pegado en celda activa (solo resultado, sin uses).');
    }catch(e){
      log('WARN: no se pudo pegar en celda activa (' + (e.message || e) + ')');
    }
  }

  function getApiUrl_(){
    const v = (elApiUrl.value || '').trim();
    const url = v || DEFAULT_API_URL;
    if (!url || url.includes('PEGA_AQUI') || url.includes('PEGA_AQUI_TU_URL_DEFINITIVA')) {
      throw new Error('URL del backend no configurada. Pega la URL /exec en DEFAULT_API_URL.');
    }
    return url;
  }

  function getToken_(){
    const t = (elToken.value || '').trim();
    if (!t) throw new Error('Pega tu token para continuar.');
    return t;
  }

  function setState_(state, uses){
    const s = (state === 'active' || state === 'invalid') ? state : 'neutral';
    elStateDot.className = 'dot ' + (s === 'active' ? 'green' : (s === 'invalid' ? 'red' : 'neutral'));

    if (s === 'neutral'){
      elStateText.textContent = 'Estado: a la espera de petición';
      return;
    }

    const u = (typeof uses !== 'undefined' && uses !== null) ? ` (${uses} usos)` : '';
    elStateText.textContent = `Estado: ${s === 'active' ? 'Activo' : 'No válido'}${u}`;
  }

  function _makeReqId_(){
    const a = Date.now().toString(36).slice(-6);
    const b = Math.random().toString(36).slice(2, 6);
    return `x${a}${b}`;
  }

  // ----------------------------
  // 8.4 — HTTP client (_fetchJson_)
  // ----------------------------
  function _tryParseJson_(txt){
    const t = String(txt || '').trim();
    if (!t) return null;
    try { return JSON.parse(t); } catch(e){ return null; }
  }

  async function _fetchJson_(url, opts, timeoutMs){
    const to = Math.max(2000, Number(timeoutMs || 0) || 15000);
    const controller = (typeof AbortController !== 'undefined') ? new AbortController() : null;
    const tmr = setTimeout(() => { try{ controller && controller.abort(); }catch(e){} }, to);

    try{
      const res = await fetch(url, Object.assign({}, opts || {}, controller ? { signal: controller.signal } : {}));
      const raw = await res.text();
      const parsed = _tryParseJson_(raw);

      if (parsed) return { ok:true, status: res.status, data: parsed, raw };
      return { ok:false, status: res.status, data: null, raw };

    }catch(e){
      const msg = (e && e.name === 'AbortError') ? `timeout_${to}ms` : (e && e.message ? e.message : String(e));
      return { ok:false, status: 0, data: null, raw: '', error: msg };
    }finally{
      clearTimeout(tmr);
    }
  }

  function _userMessageForError_(code, detail){
    const c = String(code || '').trim().toLowerCase();

    const MAP = {
      'invalid_token': 'Token inválido. Verifica que lo hayas copiado correctamente.',
      'missing_token': 'Pega tu token para continuar.',
      'expired': 'Tu token está vencido. Solicita/renueva tu acceso para continuar.',
      'no_uses_remaining': 'Se agotaron tus usos. Renueva tu plan para seguir utilizando SEPROINCA-IA.',
      'token_email_mismatch': 'Este token no corresponde a tu usuario. Verifica que sea el token correcto.',
      'invalid_action': 'Acción no válida. Selecciona una opción del menú.',
      'missing_action': 'Selecciona una acción antes de ejecutar.',
      'invalid_json': 'Solicitud inválida. Cierra y vuelve a abrir el complemento e intenta de nuevo.',
      'missing_openai_api_key': 'Servicio no disponible. Contacta al soporte de SEPROINCA-IA.',
      'openai_bad_json': 'Servicio temporalmente inestable. Intenta nuevamente.',
      'server_error': 'Ocurrió un error interno. Intenta nuevamente.',
      'auth_error': 'No se pudo validar tu acceso. Verifica tu token.'
    };

    if (MAP[c]) return MAP[c];
    if (c.startsWith('openai_http_')) return 'Servicio temporalmente no disponible. Intenta nuevamente.';
    if (c.startsWith('timeout_')) return 'La solicitud tardó demasiado. Intenta nuevamente.';

    const d = String(detail || '').trim();
    if (d && d.length <= 160 && !/[<>{}]/.test(d)) return d;

    return 'No fue posible completar la solicitud. Verifica tu token e intenta nuevamente.';
  }

  function _formatBackendError_(data, fallbackRaw){
    const code = (data && typeof data === 'object') ? data.error : '';
    const det  = (data && typeof data === 'object') ? data.detail : '';

    const userMsg = _userMessageForError_(code, det);

    const http = (data && typeof data.http !== 'undefined') ? ` (http=${data.http})` : '';
    const tech = (code ? (String(code) + http) : 'unknown_error');
    const detailTxt = det ? (' | ' + String(det)) : '';

    return { userMsg, techMsg: tech + detailTxt, raw: fallbackRaw || '' };
  }

 // ----------------------------
// 8.5 — Barras helpers (leer nombres / formateo / write names)
// ----------------------------
function _toNumberOrNull_(v){
  if (v === null || typeof v === 'undefined') return null;
  const s = String(v).replace(',', '.').trim();
  if (!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

async function readNamedNumbers_(names){
  if (typeof Excel === 'undefined' || !Excel.run){
    throw new Error('Excel API no disponible en este host.');
  }

  return await Excel.run(async (ctx) => {
    const items = {};

    for (const nm of names){
      const it = ctx.workbook.names.getItemOrNullObject(nm);
      it.load(["name","type","value"]);
      items[nm] = it;
    }
    await ctx.sync();

    const rangeToLoad = {};
    for (const nm of names){
      const it = items[nm];
      if (!it || it.isNullObject){ rangeToLoad[nm] = null; continue; }

      const t = String(it.type || '').toLowerCase();
      if (t === 'range'){
        try{
          const rng = it.getRange();
          rng.load(["values"]);
          rangeToLoad[nm] = rng;
        }catch(e){
          rangeToLoad[nm] = null;
        }
      }else{
        rangeToLoad[nm] = null;
      }
    }
    await ctx.sync();

    const res = {};
    for (const nm of names){
      const it = items[nm];
      if (!it || it.isNullObject){ res[nm] = null; continue; }

      const t = String(it.type || '').toLowerCase();
      if (t === 'range'){
        const rng = rangeToLoad[nm];
        const v = (rng && rng.values && rng.values[0]) ? rng.values[0][0] : null;
        res[nm] = _toNumberOrNull_(v);
      }else{
        res[nm] = _toNumberOrNull_(it.value);
      }
    }

    return res;
  });
}

function _diamFractionFromMm_(mm){
  const x = Number(mm);
  if (!Number.isFinite(x)) return null;

  const tol = 0.25; // tolerancia mm
  const MAP = [
    { mm: 6.35,  s: '1/4"' },
    { mm: 7.94,  s: '5/16"' },
    { mm: 9.53,  s: '3/8"' },
    { mm: 12.70, s: '1/2"' },
    { mm: 15.88, s: '5/8"' },
    { mm: 19.05, s: '3/4"' },
    { mm: 25.40, s: '1"' },
    { mm: 35.81, s: '1 3/8"' }
  ];

  let best = null;
  for (const m of MAP){
    const d = Math.abs(x - m.mm);
    if (d <= tol && (!best || d < best.d)){
      best = { d, s: m.s };
    }
  }
  return best ? best.s : null;
}

function _fmtDiam_(diamMm){
  const frac = _diamFractionFromMm_(diamMm);
  if (frac) return `Ø${frac}`;
  const x = Number(diamMm);
  if (!Number.isFinite(x)) return '—';
  return `Ø${x.toFixed(2)} mm`;
}

function _fmtDiamCell_(diamMm){
  const frac = _diamFractionFromMm_(diamMm);
  if (frac) return `${frac}`; // celda limpia
  const x = Number(diamMm);
  if (!Number.isFinite(x)) return '';
  return `${x.toFixed(2)} mm`;
}

async function writeNamedCells_(kv){
  if (typeof Excel === 'undefined' || !Excel.run){
    throw new Error('Excel API no disponible en este host.');
  }

  return await Excel.run(async (ctx) => {
    const missing = [];
    const ranges = {};

    for (const key of Object.keys(kv)){
      const it = ctx.workbook.names.getItemOrNullObject(key);
      it.load(["type"]);
      ranges[key] = { it };
    }
    await ctx.sync();

    for (const key of Object.keys(kv)){
      const it = ranges[key].it;
      if (!it || it.isNullObject){
        missing.push(key);
        ranges[key].rng = null;
        continue;
      }
      const t = String(it.type || '').toLowerCase();
      if (t !== 'range'){
        missing.push(key);
        ranges[key].rng = null;
        continue;
      }
      const rng = it.getRange();
      ranges[key].rng = rng;
    }

    if (missing.length){
      throw new Error('Faltan nombres (o no son rangos): ' + missing.join(', '));
    }

    for (const key of Object.keys(kv)){
      const rng = ranges[key].rng;
      rng.values = [[kv[key]]];
    }

    await ctx.sync();
  });
}

// ✅ NUEVO: escritura "soft" (NO lanza error si falta algún nombre)
async function writeNamedCellsSoft_(kv){
  if (typeof Excel === 'undefined' || !Excel.run){
    throw new Error('Excel API no disponible en este host.');
  }

  return await Excel.run(async (ctx) => {
    const items = [];

    for (const key of Object.keys(kv)){
      const it = ctx.workbook.names.getItemOrNullObject(key);
      it.load(["type"]);
      items.push({ key, it });
    }
    await ctx.sync();

    const skipped = [];
    for (const item of items){
      const it = item.it;
      if (!it || it.isNullObject){ skipped.push(item.key); continue; }

      const t = String(it.type || '').toLowerCase();
      if (t !== 'range'){ skipped.push(item.key); continue; }

      try{
        const rng = it.getRange();
        rng.values = [[kv[item.key]]];
      }catch(e){
        skipped.push(item.key);
      }
    }

    await ctx.sync();

    if (skipped.length){
      log('WARN Barras: algunos nombres no se pudieron escribir (soft): ' + skipped.join(', '));
    }
  });
}

// ✅ NUEVO: limpieza forzada de TODAS las celdas de barras
async function clearBarsNamedCells_(){
  const kv = {
    // Opción 1
    Sup_Diam_1: '', Sup_n_1: '', Sup_Diam_2: '', Sup_n_2: '',
    Inf_Diam_1: '', Inf_n_1: '', Inf_Diam_2: '', Inf_n_2: '',

    // Opción 2
    Sup2_Diam_1: '', Sup2_n_1: '', Sup2_Diam_2: '', Sup2_n_2: '',
    Inf2_Diam_1: '', Inf2_n_1: '', Inf2_Diam_2: '', Inf2_n_2: '',

    // As provistos (cm2)
    As_prov_sup1: '', As_prov_sup2: '', As_prov_inf1: '', As_prov_inf2: ''
  };

  await writeNamedCellsSoft_(kv);
  log('Barras: limpieza forzada aplicada (todas las celdas).');
}

function _optToCells_(opt){
  // ✅ Si no hay opción: vaciar todo (limpieza real)
  if (!opt) {
    return { n1:'', d1:'', n2:'', d2:'', As:'', exc:'' };
  }
  const n1 = (opt.n_1 != null) ? Number(opt.n_1) : '';
  const d1 = (opt.diam_1_mm != null) ? _fmtDiamCell_(opt.diam_1_mm) : '';
  const n2 = (opt.n_2 != null && Number(opt.n_2) > 0) ? Number(opt.n_2) : '';
  const d2 = (opt.diam_2_mm != null && Number(opt.n_2) > 0) ? _fmtDiamCell_(opt.diam_2_mm) : '';

  const As = (opt.As_prov_cm2 != null) ? Number(opt.As_prov_cm2) : '';
  const exc = (opt.excess_cm2 != null) ? Number(opt.excess_cm2) : '';

  return { n1, d1, n2, d2, As, exc };
}

async function writeBarsToNamedCells2_(barsData){
  const supOpts = (barsData && barsData.sup && Array.isArray(barsData.sup.options)) ? barsData.sup.options : [];
  const infOpts = (barsData && barsData.inf && Array.isArray(barsData.inf.options)) ? barsData.inf.options : [];

  const sup1 = supOpts[0] || null;
  const sup2 = supOpts[1] || null;
  const inf1 = infOpts[0] || null;
  const inf2 = infOpts[1] || null;

  const s1 = _optToCells_(sup1);
  const s2 = _optToCells_(sup2);
  const i1 = _optToCells_(inf1);
  const i2 = _optToCells_(inf2);

  const kv = {
    // Opción 1
    Sup_Diam_1: s1.d1,
    Sup_n_1: s1.n1,
    Sup_Diam_2: s1.d2,
    Sup_n_2: s1.n2,

    Inf_Diam_1: i1.d1,
    Inf_n_1: i1.n1,
    Inf_Diam_2: i1.d2,
    Inf_n_2: i1.n2,

    // Opción 2
    Sup2_Diam_1: s2.d1,
    Sup2_n_1: s2.n1,
    Sup2_Diam_2: s2.d2,
    Sup2_n_2: s2.n2,

    Inf2_Diam_1: i2.d1,
    Inf2_n_1: i2.n1,
    Inf2_Diam_2: i2.d2,
    Inf2_n_2: i2.n2,

    // As provistos (cm2)
    As_prov_sup1: (s1.As === '' ? '' : Number(s1.As).toFixed(3)),
    As_prov_sup2: (s2.As === '' ? '' : Number(s2.As).toFixed(3)),
    As_prov_inf1: (i1.As === '' ? '' : Number(i1.As).toFixed(3)),
    As_prov_inf2: (i2.As === '' ? '' : Number(i2.As).toFixed(3)),
  };

  // ✅ CLAVE: usar soft (así nunca deja valores viejos por un throw)
  await writeNamedCellsSoft_(kv);

  if (!supOpts.length) log('Barras: SUP sin opciones → celdas SUP limpiadas.');
  if (!infOpts.length) log('Barras: INF sin opciones → celdas INF limpiadas.');
  log('Barras: celdas por nombre rellenadas/limpiadas (Opción 1 y 2 + As_prov_*).');
}

function _fmtOptionLine_(zona, idx, opt){
  if (!opt) return `${zona} Opción ${idx}: —`;
  const n1 = (opt.n_1 != null) ? Number(opt.n_1) : '';
  const d1 = _fmtDiam_(opt.diam_1_mm);
  const n2 = (opt.n_2 != null && Number(opt.n_2) > 0) ? Number(opt.n_2) : 0;
  const d2 = (n2 > 0) ? _fmtDiam_(opt.diam_2_mm) : '';

  if (n2 > 0){
    return `${zona} Opción ${idx}: ${n1} ${d1} + ${n2} ${d2} | As=${Number(opt.As_prov_cm2||0).toFixed(3)} cm²`;
  }
  return `${zona} Opción ${idx}: ${n1} ${d1} | As=${Number(opt.As_prov_cm2||0).toFixed(3)} cm²`;
}

// ----------------------------
// 8.6 — Barras: lectura robusta de As y geometría (mm)
// ----------------------------
function _coalesce_(){
  for (let i = 0; i < arguments.length; i++){
    const v = arguments[i];
    if (v !== null && typeof v !== 'undefined' && v !== '') return v;
  }
  return null;
}

function _cmToMm_(cm){
  const x = Number(cm);
  return Number.isFinite(x) ? x * 10.0 : null;
}

function _safeNum_(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

// ----------------------------
// 8.6 — ping_ / execute_ / useSelection_
// ----------------------------
async function ping_(){
  try{
    setBusy(true);
    const base = getApiUrl_();
    const url = base + (base.includes('?') ? '&' : '?') + 't=' + Date.now();

    log('Ping GET (JSON-only esperado)');
    const out = await _fetchJson_(url, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    }, API_TIMEOUT_MS_PING);

    if (!out.ok && out.error){
      showERR('No se pudo conectar. ' + out.error);
      log('Ping ERROR: ' + out.error);
      setState_('neutral');
      return;
    }

    if (out.ok && out.data){
      const d = out.data;
      if (d.ok){
        const txt = [
          `service: ${d.service || '—'}`,
          `version: ${d.version || '—'}`,
          `now: ${d.now || '—'}`
        ].join('\n');
        showOK(txt);
        log('Ping OK (version=' + (d.version || '—') + ')');
        setState_('neutral');
      }else{
        const f = _formatBackendError_(d, out.raw);
        showERR(f.userMsg);
        log('Ping ERROR (backend): ' + f.techMsg);
        setState_('neutral');
      }
    }else{
      showERR('El servidor respondió de forma inesperada. Intenta nuevamente.');
      log('Ping ERROR: respuesta no JSON');
      setState_('neutral');
    }

  }catch(e){
    showERR(e.message || String(e));
    log('Ping ERROR: ' + (e.message || e));
    setState_('neutral');
  }finally{
    setBusy(false);
  }
}

// ✅ Extra: extraer summary_text de forma robusta (evita "Barras OK." cuando sí hay summary)
function _extractBarsSummary_(topLevelData, barsEnvelope){
  if (topLevelData && typeof topLevelData.summary_text === 'string' && topLevelData.summary_text.trim()){
    return topLevelData.summary_text;
  }
  if (barsEnvelope && typeof barsEnvelope.summary_text === 'string' && barsEnvelope.summary_text.trim()){
    return barsEnvelope.summary_text;
  }
  if (barsEnvelope && barsEnvelope.ok && barsEnvelope.data && typeof barsEnvelope.data === 'object'){
    if (typeof barsEnvelope.summary_text === 'string' && barsEnvelope.summary_text.trim()){
      return barsEnvelope.summary_text;
    }
    if (typeof barsEnvelope.data.summary_text === 'string' && barsEnvelope.data.summary_text.trim()){
      return barsEnvelope.data.summary_text;
    }
  }
  if (topLevelData && typeof topLevelData.result === 'string' && topLevelData.result.trim()){
    return topLevelData.result;
  }
  return 'Barras OK.';
}

async function execute_(){
  try{
    setBusy(true);

    const token = getToken_();
    await storageSet_('seproincaia.token.last', token);

    const action = elAction.value || 'Analizar';
    const instruction = (elInstr.value || '').trim();

    let payload = { selectionText: '', instruction, mode: currentMode };

    if (action !== 'Barras'){
      const selectionText = (elSelText.value || '').trim();
      if (!selectionText) throw new Error('Primero usa “Usar selección actual” o pega texto en “Selección (texto)”.');
      payload.selectionText = selectionText;
    }else{
      const vals = await readNamedNumbers_([
        "As_req_neg_cm2", "As_req_pos_cm2",
        "As_req_neg", "As_req_pos",
        "As_req_sup", "As_req_inf",

        "b_sup_mm", "b_inf_mm",
        "bw_sup_mm", "bw_inf_mm",
        "ancho_sup_mm", "ancho_inf_mm",

        "bsup", "binf", "b",

        "cover_mm", "rec_mm", "recubrimiento_mm",
        "rec", "cover",

        "stirrup_diam_mm", "diam_estribo_mm", "estribo_mm",
        "sep_min_mm", "separacion_min_mm", "sep_min"
      ]);

      const AsNeg = _coalesce_(vals.As_req_neg_cm2, vals.As_req_neg, vals.As_req_sup);
      const AsPos = _coalesce_(vals.As_req_pos_cm2, vals.As_req_pos, vals.As_req_inf);

      if (AsNeg == null || AsPos == null){
        throw new Error(
          'Faltan nombres en Excel para acero requerido.\n' +
          'Usa: As_req_neg_cm2 y As_req_pos_cm2 (recomendado)\n' +
          'o compat: As_req_neg y As_req_pos.'
        );
      }

      let bSupMm = _coalesce_(vals.b_sup_mm, vals.bw_sup_mm, vals.ancho_sup_mm);
      let bInfMm = _coalesce_(vals.b_inf_mm, vals.bw_inf_mm, vals.ancho_inf_mm);

      const bsup_cm = vals.bsup;
      const binf_cm = vals.binf;
      const b_cm    = vals.b;

      if (bSupMm == null && bsup_cm != null) bSupMm = _cmToMm_(bsup_cm);
      if (bInfMm == null && binf_cm != null) bInfMm = _cmToMm_(binf_cm);

      if (bSupMm == null && b_cm != null) bSupMm = _cmToMm_(b_cm);
      if (bInfMm == null && b_cm != null) bInfMm = _cmToMm_(b_cm);

      let coverMm = _coalesce_(vals.cover_mm, vals.rec_mm, vals.recubrimiento_mm);
      const rec_cm = _coalesce_(vals.rec, vals.cover);
      if (coverMm == null && rec_cm != null) coverMm = _cmToMm_(rec_cm);

      const stirrupMm = _coalesce_(vals.stirrup_diam_mm, vals.diam_estribo_mm, vals.estribo_mm);
      const sepMinMm  = _coalesce_(vals.sep_min_mm, vals.separacion_min_mm, vals.sep_min);

      payload = {
        kind: "fundamentos_barras_v1",
        As_req_neg_cm2: Number(AsNeg),
        As_req_pos_cm2: Number(AsPos),

        b_sup_mm: _safeNum_(bSupMm),
        b_inf_mm: _safeNum_(bInfMm),
        cover_mm: _safeNum_(coverMm),
        stirrup_diam_mm: _safeNum_(stirrupMm),
        sep_min_mm: _safeNum_(sepMinMm),

        instruction,
        mode: currentMode
      };

      log('Barras payload (geom): ' + JSON.stringify({
        As_req_neg_cm2: payload.As_req_neg_cm2,
        As_req_pos_cm2: payload.As_req_pos_cm2,
        b_sup_mm: payload.b_sup_mm,
        b_inf_mm: payload.b_inf_mm,
        cover_mm: payload.cover_mm,
        stirrup_diam_mm: payload.stirrup_diam_mm,
        sep_min_mm: payload.sep_min_mm
      }));
    }

    const request_id = _makeReqId_();

    const bodyObj = {
      action,
      token,
      email: "",
      payload,
      request_id
    };

    const url = getApiUrl_();
    log(`POST → ${action} (modo=${currentMode}) [${request_id}]`);

    const out = await _fetchJson_(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
        'Accept': 'application/json'
      },
      body: JSON.stringify(bodyObj)
    }, API_TIMEOUT_MS_POST);

    if (!out.ok && out.error){
      const msg = 'No se pudo conectar. ' + out.error;
      showERR(msg);
      log('ERROR red: ' + out.error);
      setState_('neutral');
      return;
    }

    const data = out.data;

    if (data && data.ok){
      log('OK: respuesta recibida');

      const uses = (typeof data.uses_remaining !== 'undefined') ? data.uses_remaining : undefined;
      setState_('active', uses);

      // ====================================================
      // SUB-BLOQUE: Barras (escritura por nombres)
      // ====================================================
      if (action === 'Barras'){
        const barsEnvelope = (data.data && typeof data.data === 'object') ? data.data : null;
        if (!barsEnvelope){
          showERR('Barras: el backend no devolvió "data".');
          log('ERROR Barras: falta data en respuesta.');
          return;
        }

        const model = (barsEnvelope.ok && barsEnvelope.data && typeof barsEnvelope.data === 'object')
          ? barsEnvelope.data
          : barsEnvelope;

        if (model && model.error){
          showERR('Barras: ' + String(model.error));
          log('Barras ERROR (model.error): ' + String(model.error));
          return;
        }

        const supOpts = (model.sup && Array.isArray(model.sup.options)) ? model.sup.options : [];
        const infOpts = (model.inf && Array.isArray(model.inf.options)) ? model.inf.options : [];

        // ✅ CASO CRÍTICO: NO HAY OPCIONES EN SUP NI EN INF → LIMPIAR TODO SIEMPRE
        if (!supOpts.length && !infOpts.length){
          try{
            await clearBarsNamedCells_();
          }catch(e){
            log('WARN Barras: no se pudo limpiar todo: ' + (e.message || e));
          }

          const noteSup = (model.sup && model.sup.note) ? String(model.sup.note) : '';
          const noteInf = (model.inf && model.inf.note) ? String(model.inf.note) : '';
          const extra = [
            noteSup ? ('SUP:\n' + noteSup) : '',
            noteInf ? ('INF:\n' + noteInf) : ''
          ].filter(Boolean).join('\n\n');

          showERR('Barras: No se encontraron combinaciones factibles con los límites actuales.' + (extra ? '\n\n' + extra : ''));
          log('Barras: options vacías en ambas zonas → se limpió Excel.');
          return;
        }

        // ✅ CASOS NORMALES
        const summary = _extractBarsSummary_(data, barsEnvelope);
        showOK(String(summary || '').trim() || 'Barras OK.');

        // ✅ SIEMPRE escribir/limpiar lo que corresponda
        await writeBarsToNamedCells2_(model);
        return;
      }

      // ... (resto de tus otros modos)
    }

  }catch(e){
    showERR(e.message || String(e));
    log('ERROR: ' + (e.message || e));
    setState_('neutral');
  }finally{
    setBusy(false);
  }
}



        // ====================================================
        // SUB-BLOQUE: Otros modos (pegar resultado)
        // ====================================================
        const uiExtra = (typeof data.uses_remaining !== 'undefined')
          ? `\n\n[uses_remaining: ${data.uses_remaining}]`
          : '';
        const uiText = String(data.result || '') + uiExtra;

        showOK(uiText);
        await writeResultToActiveCell_(String(data.result || ''));

      }else{
        const f = _formatBackendError_(data, out.raw);
        showERR(f.userMsg);
        log('ERROR backend: ' + f.techMsg);

        const usesErr = (data && typeof data.uses_remaining !== 'undefined') ? data.uses_remaining : undefined;
        setState_('invalid', usesErr);
      }

    }catch(e){
      showERR(e.message || String(e));
      log('ERROR: ' + (e.message || e));
      setState_('neutral');
    }finally{
      setBusy(false);
    }
  }

  async function useSelection_(){
    try{
      setBusy(true);
      const s = await readSelectionExcel_();
      updateRangeInfo_(s.addr, s.rows, s.cols);

      elSelText.value = s.text || '';

      if (!s.text){
        showERR('Selección vacía. Selecciona celdas con contenido.');
        log('Selección vacía.');
        return;
      }

      showOK(`Selección cargada (${s.text.length} caracteres).`);
      log(`Selección cargada: ${s.addr} (${s.rows}×${s.cols}).`);
    }catch(e){
      showERR(e.message || String(e));
      log('ERROR selección: ' + (e.message || e));
    }finally{
      setBusy(false);
    }
  }

  // ----------------------------
  // 8.7 — Office.onReady wiring
  // ----------------------------
  Office.onReady(async (info) => {
    const host = (info && info.host) ? info.host : 'unknown';

    if (elHostText) elHostText.textContent = 'host: ' + host;
    elHostDot.className = 'dot green';

    elApiUrl.value = DEFAULT_API_URL;
    setLogVisible_(false);

    const last = await storageGet_('seproincaia.token.last');
    if (last) {
      elToken.value = last;
      log('Token cargado desde memoria local.');
    } else {
      log('Sin token guardado todavía.');
    }

    setMode('Aprendizaje');
    setState_('neutral');

    btnUseSelection.addEventListener('click', useSelection_);
    btnExecute.addEventListener('click', execute_);
    btnPing.addEventListener('click', ping_);

    btnModeLearn.addEventListener('click', () => setMode('Aprendizaje'));
    btnModeProd.classList.toggle('active', false);
    btnModeProd.addEventListener('click', () => setMode('Producción'));

    btnToggleLog.addEventListener('click', () => {
      const isHidden = elLogWrap.classList.contains('logHidden');
      setLogVisible_(isHidden);
    });

    let tmr = null;
    elToken.addEventListener('input', () => {
      if (tmr) clearTimeout(tmr);
      tmr = setTimeout(async () => {
        const t = (elToken.value || '').trim();
        if (t) await storageSet_('seproincaia.token.last', t);
        else await storageDel_('seproincaia.token.last');
      }, 350);
    });

    showOK(
      'Listo.\n\n' +
      '1) Pega tu token\n' +
      '2) (Opcional) Selecciona celdas → “Usar selección actual”\n' +
      '3) Ejecutar\n\n' +
      'Modo Barras (Fundamentos):\n' +
      '- Deben existir nombres: As_req_neg_cm2 y As_req_pos_cm2 (recomendado)\n' +
      '  (compat: As_req_neg / As_req_pos)\n' +
      '- (Opcional) geometría para n_max automático:\n' +
      '  b_sup_mm y b_inf_mm (recomendado)\n' +
      '  (compat: bsup/binf/b en cm)\n' +
      '- (Opcional) cover_mm, stirrup_diam_mm, sep_min_mm\n' +
      '- Deben existir celdas con nombre:\n' +
      '  Opción 1: Sup_Diam_1, Sup_n_1, Sup_Diam_2, Sup_n_2, Inf_Diam_1, Inf_n_1, Inf_Diam_2, Inf_n_2\n' +
      '  Opción 2: Sup2_Diam_1, Sup2_n_1, Sup2_Diam_2, Sup2_n_2, Inf2_Diam_1, Inf2_n_1, Inf2_Diam_2, Inf2_n_2\n' +
      '  As prov: As_prov_sup1, As_prov_sup2, As_prov_inf1, As_prov_inf2\n' +
      '- Ejecutar llena esos nombres con 2 opciones por zona.'
    );
    log('Office.onReady OK (host=' + host + ')');
  });

})();
</script>

</body>
</html>
