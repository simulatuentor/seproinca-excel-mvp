<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEPROINCA-IA</title>

  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <style>
    :root{
      --blue1:#1f4f86;
      --blue2:#163d69;
      --ink:#0f172a;
      --muted:#6b7280;
      --b:#e5e7eb;
      --bg:#ffffff;
      --card:#ffffff;

      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#ef4444;
      --btn:#0b3a64;
      --btn2:#0f4b82;

      --shadow: 0 6px 18px rgba(15,23,42,.08);
      --shadow2: 0 6px 14px rgba(15,23,42,.08);
      --radius: 14px;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Segoe UI", Inter, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    .header{
      background: linear-gradient(180deg, var(--blue1), var(--blue2));
      color:#fff;
      padding: 14px 14px 12px;
      position: sticky;
      top:0;
      z-index: 5;
      box-shadow: 0 4px 18px rgba(0,0,0,.18);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.5px;
      font-size:18px;
    }
    .brand .logo{
      width:22px;
      height:22px;
      border:2px solid rgba(255,255,255,.9);
      border-left-color: transparent;
      transform: rotate(45deg);
      border-radius: 4px;
    }
    .sub{
      opacity:.92;
      font-size:12.5px;
      margin-top:4px;
      letter-spacing:.2px;
    }

    .wrap{
      padding: 12px 12px 18px;
      max-width: 520px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--b);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      margin-bottom: 12px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .label{
      font-size:12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }

    input, textarea, select{
      width:100%;
      box-sizing:border-box;
      padding: 10px 11px;
      border: 1px solid var(--b);
      border-radius: 12px;
      font-size:14px;
      outline: none;
      background:#fff;
    }
    textarea{ min-height: 82px; resize: vertical; }

    select{
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #334155 50%),
        linear-gradient(135deg, #334155 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 12px) calc(50% - 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 34px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.12);
      color: #fff;
      user-select:none;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:#9ca3af;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.35);
    }
    .dot.green{ background: #22c55e; }
    .dot.red{ background: #ef4444; }
    .dot.neutral{ background:#9ca3af; }

    .btn{
      width:100%;
      border:0;
      border-radius: 14px;
      padding: 12px 12px;
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color:#fff;
      font-size: 15px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(11,58,100,.18);
    }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .btnGhost{
      border:1px solid var(--b);
      background:#fff;
      color:#111827;
      font-weight:700;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      width:100%;
    }
    .btnGhost:disabled{ opacity:.6; cursor:not-allowed; }

    .log{
      background:#f6f8fa;
      border-radius: 12px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 240px;
      overflow:auto;
      border: 1px solid #eef2f7;
    }

    .ok{ color:#065f46; font-weight:900; }
    .bad{ color:#991b1b; font-weight:900; }

    .hint{
      font-size:12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }

    .collapseHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .logHidden{ display:none; }

    /* ---------- Premium header Resultado ---------- */
    .resultHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .rightActions{
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* Icon buttons */
    .iconBtn{
      width:34px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--b);
      background:#fff;
      color:#6b7280;              /* gris cuando está apagado */
      border-radius: 12px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, box-shadow .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
    }
    .iconBtn:hover{ background:#fbfdff; }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .iconBtn svg{ width:18px; height:18px; display:block; }

    /* Activo (historial ON) */
    .iconBtn.isOn{
      background:#eaf2ff;
      border-color:#cfe2ff;
      color:#0b3a64;
    }

    /* ---------- Vista Limpia ---------- */
    body.viewClean .cardLog{ display:none !important; }
    body.viewClean #btnPing{ display:none !important; }
    body.viewClean #btnToggleLog{ display:none !important; }
    body.viewClean #hostChip{ display:none !important; }
  </style>
</head>

<body>
  <div class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>SEPROINCA-IA</div>
    </div>
    <div class="sub">Fundamentos — Nervio Sección T</div>
    <div class="row" style="margin-top:10px; justify-content:space-between;">
      <div class="chip" id="hostChip">
        <span class="dot" id="hostDot"></span>
        <span id="hostText">host: ?</span>
      </div>

      <div class="chip" id="tokenStateChip">
        <span class="dot neutral" id="stateDot"></span>
        <span id="stateText">Estado: a la espera de petición</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="label" style="margin-top:0;">Token</div>
      <input id="token" type="text" placeholder="Pega aquí tu token (se recordará automáticamente)" />
      <div class="hint">Tip: el token se guarda localmente en tu Excel y queda editable por si deseas cambiarlo.</div>

      <input id="apiUrl" type="text" style="display:none" />
    </div>

    <div class="card">
      <div style="font-weight:900; margin-bottom:8px;">Acción</div>

      <div class="label" style="margin-top:0;">¿Qué quieres hacer?</div>
      <select id="actionSelect">
        <option value="Redactar">Redactar — Comentarios técnicos y conclusiones (pega en celda activa)</option>
        <option value="Barras">Barras — Propuesta de combinación de barras (lee nombres y escribe por nombre)</option>
      </select>

      <div class="label">Instrucción (opcional)</div>
      <input id="instruction" type="text" placeholder="Ej: enfócate en limitación geométrica, o en sugerir alternativa práctica..." />

      <div style="height:10px"></div>
      <button class="btn" id="btnExecute" type="button">Ejecutar</button>

      <div class="hint" id="miniHint">
        <b>Redactar:</b> párate en la celda de Conclusiones (ej. B71:I79) y pulsa Ejecutar.<br>
        <b>Barras:</b> pulsa Ejecutar (rellena celdas por nombre).
      </div>
    </div>

    <div class="card">
      <div class="resultHeader">
        <div style="font-weight:900;">Resultado</div>

        <div class="rightActions">
          <!-- Orden pedido: Copiar, Limpiar, Historial -->
          <button class="iconBtn" id="btnCopyResult" type="button" title="Copiar">
            <!-- Copy -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M16 1H6a2 2 0 0 0-2 2v12h2V3h10V1zm3 4H10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H10V7h9v14z"/>
            </svg>
          </button>

          <button class="iconBtn" id="btnClearResult" type="button" title="Limpiar">
            <!-- Trash -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2z"/>
            </svg>
          </button>

          <!-- Historial / Informe (toggle vista técnica) -->
          <button class="iconBtn" id="btnToggleTech" type="button" title="Ver historial / informe">
            <!-- Documento + Lupa (lupa con stroke para que se vea sí o sí) -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <!-- doc -->
              <path fill="currentColor" d="M6 2h8l4 4v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V7h3.5L14 3.5z"/>
              <!-- magnifier (stroke) -->
              <circle cx="10.5" cy="10.3" r="2.7" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M13.0 12.8L16.2 16.0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div id="result" class="log">Listo. Pega tu token y elige Redactar o Barras.</div>
    </div>

    <div class="card cardLog">
      <div class="collapseHeader">
        <div style="font-weight:900;">Log</div>
        <div class="row" style="gap:8px;">
          <button class="btnGhost" id="btnPing" type="button" style="width:auto; padding:8px 10px;">Ping</button>
          <button class="btnGhost" id="btnToggleLog" type="button" style="width:auto; padding:8px 10px;">Ver log</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div id="logWrap" class="logHidden">
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (s) => document.querySelector(s);

  const elHostChip = $('#hostChip');
  const elHostDot  = $('#hostDot');
  const elHostText = $('#hostText');

  const elToken = $('#token');
  const elApiUrl = $('#apiUrl');

  const elStateDot  = $('#stateDot');
  const elStateText = $('#stateText');

  const elInstr   = $('#instruction');
  const elAction  = $('#actionSelect');

  const elResult = $('#result');
  const elLog    = $('#log');

  const btnExecute = $('#btnExecute');
  const btnPing = $('#btnPing');

  const btnToggleLog = $('#btnToggleLog');
  const elLogWrap = $('#logWrap');

  const btnCopyResult  = $('#btnCopyResult');
  const btnClearResult = $('#btnClearResult');
  const btnToggleTech  = $('#btnToggleTech');

  const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbwjODmMUtcK31iWBTUbEJcz8LnKZ8qUoCzBx7Sv16N8-jSSbAntQ8csTOicsozAfqRHcQ/exec";

  const API_TIMEOUT_MS_PING = 15000;
  const API_TIMEOUT_MS_POST = 35000;

  const LOGP = "[SEPROINCA-IA][Excel] ";

  function storageAvailable_(){
    try{
      return (typeof Office !== 'undefined'
        && Office.Runtime
        && Office.Runtime.storage
        && typeof Office.Runtime.storage.getItem === 'function');
    }catch(e){ return false; }
  }

  async function storageGet_(key){
    if (storageAvailable_()){
      const v = await Office.Runtime.storage.getItem(key);
      return v || '';
    }
    return localStorage.getItem(key) || '';
  }

  async function storageSet_(key, value){
    if (storageAvailable_()){
      await Office.Runtime.storage.setItem(key, value);
      return;
    }
    localStorage.setItem(key, value);
  }

  async function storageDel_(key){
    if (storageAvailable_()){
      await Office.Runtime.storage.removeItem(key);
      return;
    }
    localStorage.removeItem(key);
  }

  function log(msg){
    const line = `[${new Date().toLocaleTimeString()}] ${LOGP}${msg}\n`;
    elLog.textContent = line + (elLog.textContent || '');
  }

  function escapeHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');
  }

  function showOK(text){
    elResult.innerHTML = `<span class="ok">OK</span>\n\n${escapeHtml(text || '')}`;
  }
  function showERR(text){
    elResult.innerHTML = `<span class="bad">ERROR</span>\n\n${escapeHtml(text || '')}`;
  }

  function setBusy(isBusy){
    [btnExecute, btnPing, btnToggleLog, btnCopyResult, btnClearResult, btnToggleTech]
      .forEach(b => b && (b.disabled = !!isBusy));
    elToken.disabled = !!isBusy;
    elInstr.disabled = !!isBusy;
    elAction.disabled = !!isBusy;
  }

  function setLogVisible_(visible){
    const v = !!visible;
    elLogWrap.classList.toggle('logHidden', !v);
    btnToggleLog.textContent = v ? 'Ocultar log' : 'Ver log';
  }

  function isTech_(){
    return !document.body.classList.contains('viewClean');
  }

  function setView_(view){
    const v = (view === 'tech') ? 'tech' : 'clean';
    document.body.classList.toggle('viewClean', v === 'clean');

    const on = (v === 'tech');
    btnToggleTech.classList.toggle('isOn', on);
    btnToggleTech.title = on ? 'Ocultar historial / informe' : 'Ver historial / informe';

    // ✅ regla: si entra a TECH -> mostrar card + desplegar log automáticamente
    if (v === 'tech'){
      setLogVisible_(true);
    }else{
      // si vuelve a CLEAN -> ocultar log (para no “quedar abierto”)
      setLogVisible_(false);
    }

    storageSet_('seproincaia.view', v).catch(()=>{});
    log('Vista: ' + (v === 'clean' ? 'Limpia' : 'Técnica'));
  }

  function toggleView_(){
    setView_(isTech_() ? 'clean' : 'tech');
  }

  async function copyResult_(){
    try{
      const txt = String(elResult.textContent || '').trim();
      if (!txt) return;

      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(txt);
        log('Copiado al portapapeles.');
        return;
      }

      const ta = document.createElement('textarea');
      ta.value = txt;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      log('Copiado al portapapeles (fallback).');

    }catch(e){
      log('WARN copiar: ' + (e.message || e));
    }
  }

  function clearResult_(){
    try{
      elResult.textContent = 'Listo. Pega tu token y elige Redactar o Barras.';
      log('Resultado limpiado.');
    }catch(e){
      log('WARN limpiar: ' + (e.message || e));
    }
  }

  async function writeResultToActiveCell_(text){
    try{
      if (typeof Excel === 'undefined' || !Excel.run) return;

      const out = String(text || '').trim();
      if (!out) return;

      let restorePack = null;

      await Excel.run(async (ctx) => {
        const wb = ctx.workbook;
        const sheet = wb.worksheets.getActiveWorksheet();
        const active = wb.getActiveCell();

        const merged = active.getMergedAreasOrNullObject();
        merged.load(["isNullObject", "columnIndex", "columnCount"]);
        active.load(["columnIndex", "columnCount"]);
        await ctx.sync();

        const target = (!merged.isNullObject) ? merged : active;

        const col0 = target.columnIndex;
        const colCount = target.columnCount;

        const colRanges = [];
        for (let i = 0; i < colCount; i++){
          const r = sheet.getRangeByIndexes(0, col0 + i, 1, 1);
          r.format.load("columnWidth");
          colRanges.push(r);
        }
        await ctx.sync();

        const widths = colRanges.map(r => r.format.columnWidth);
        restorePack = { col0, colCount, widths };

        target.values = [[out]];
        target.format.wrapText = true;
        target.format.horizontalAlignment = "Left";
        target.format.verticalAlignment = "Top";

        await ctx.sync();

        try{ target.format.autofitRows(); }catch(e){}
        await ctx.sync();

        for (let i = 0; i < colRanges.length; i++){
          try{
            if (widths[i] != null) colRanges[i].format.columnWidth = widths[i];
          }catch(e){}
        }
        await ctx.sync();
      });

      await new Promise(r => setTimeout(r, 0));

      if (restorePack && restorePack.colCount > 0){
        await Excel.run(async (ctx) => {
          const sheet = ctx.workbook.worksheets.getActiveWorksheet();
          for (let i = 0; i < restorePack.colCount; i++){
            const w = restorePack.widths[i];
            if (w == null) continue;
            const r = sheet.getRangeByIndexes(0, restorePack.col0 + i, 1, 1);
            r.format.columnWidth = w;
          }
          await ctx.sync();
        });
      }

      log('Resultado pegado en celda activa (anchos preservados).');
    }catch(e){
      log('WARN: no se pudo pegar en celda activa (' + (e.message || e) + ')');
    }
  }

  function getApiUrl_(){
    const v = (elApiUrl.value || '').trim();
    const url = v || DEFAULT_API_URL;
    if (!url || url.includes('PEGA_AQUI') || url.includes('PEGA_AQUI_TU_URL_DEFINITIVA')) {
      throw new Error('URL del backend no configurada. Pega la URL /exec en DEFAULT_API_URL.');
    }
    return url;
  }

  function getToken_(){
    const t = (elToken.value || '').trim();
    if (!t) throw new Error('Pega tu token para continuar.');
    return t;
  }

  function setState_(state, uses){
    const s = (state === 'active' || state === 'invalid') ? state : 'neutral';
    elStateDot.className = 'dot ' + (s === 'active' ? 'green' : (s === 'invalid' ? 'red' : 'neutral'));

    if (s === 'neutral'){
      elStateText.textContent = 'Estado: a la espera de petición';
      return;
    }

    const u = (typeof uses !== 'undefined' && uses !== null) ? ` (${uses} usos)` : '';
    elStateText.textContent = `Estado: ${s === 'active' ? 'Activo' : 'No válido'}${u}`;
  }

  function _makeReqId_(){
    const a = Date.now().toString(36).slice(-6);
    const b = Math.random().toString(36).slice(2, 6);
    return `x${a}${b}`;
  }

  function _tryParseJson_(txt){
    const t = String(txt || '').trim();
    if (!t) return null;
    try { return JSON.parse(t); } catch(e){ return null; }
  }

  async function _fetchJson_(url, opts, timeoutMs){
    const to = Math.max(2000, Number(timeoutMs || 0) || 15000);
    const controller = (typeof AbortController !== 'undefined') ? new AbortController() : null;
    const tmr = setTimeout(() => { try{ controller && controller.abort(); }catch(e){} }, to);

    try{
      const res = await fetch(url, Object.assign({}, opts || {}, controller ? { signal: controller.signal } : {}));
      const raw = await res.text();
      const parsed = _tryParseJson_(raw);

      if (parsed) return { ok:true, status: res.status, data: parsed, raw };
      return { ok:false, status: res.status, data: null, raw };

    }catch(e){
      const msg = (e && e.name === 'AbortError') ? `timeout_${to}ms` : (e && e.message ? e.message : String(e));
      return { ok:false, status: 0, data: null, raw: '', error: msg };
    }finally{
      clearTimeout(tmr);
    }
  }

  async function ping_(){
    try{
      setBusy(true);
      const base = getApiUrl_();
      const url = base + (base.includes('?') ? '&' : '?') + 't=' + Date.now();

      log('Ping GET (JSON-only esperado)');
      const out = await _fetchJson_(url, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      }, API_TIMEOUT_MS_PING);

      if (!out.ok && out.error){
        showERR('No se pudo conectar. ' + out.error);
        log('Ping ERROR: ' + out.error);
        setState_('neutral');
        return;
      }

      if (out.ok && out.data){
        const d = out.data;
        if (d.ok){
          showOK([`service: ${d.service || '—'}`,`version: ${d.version || '—'}`,`now: ${d.now || '—'}`].join('\n'));
          log('Ping OK (version=' + (d.version || '—') + ')');
          setState_('neutral');
        }else{
          showERR('Ping: error backend.');
          log('Ping ERROR (backend).');
          setState_('neutral');
        }
      }else{
        showERR('El servidor respondió de forma inesperada.');
        log('Ping ERROR: respuesta no JSON');
        setState_('neutral');
      }

    }catch(e){
      showERR(e.message || String(e));
      log('Ping ERROR: ' + (e.message || e));
      setState_('neutral');
    }finally{
      setBusy(false);
    }
  }

  async function execute_(){
    try{
      setBusy(true);

      const token = getToken_();
      await storageSet_('seproincaia.token.last', token);

      const action = elAction.value || 'Redactar';
      const instruction = (elInstr.value || '').trim();

      const request_id = _makeReqId_();
      const bodyObj = {
        action,
        token,
        email: "",
        payload: { instruction },   // ✅ MODO eliminado
        request_id
      };

      const url = getApiUrl_();
      log(`POST → ${action} [${request_id}]`);

      const out = await _fetchJson_(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8', 'Accept': 'application/json' },
        body: JSON.stringify(bodyObj)
      }, API_TIMEOUT_MS_POST);

      if (!out.ok && out.error){
        showERR('No se pudo conectar. ' + out.error);
        log('ERROR red: ' + out.error);
        setState_('neutral');
        return;
      }

      const data = out.data;

      if (data && data.ok){
        log('OK: respuesta recibida');
        setState_('active', (typeof data.uses_remaining !== 'undefined') ? data.uses_remaining : undefined);

        const uiText = String(data.result || '');
        showOK(uiText);

        if (action === 'Redactar'){
          await writeResultToActiveCell_(String(data.result || ''));
        }
      }else{
        showERR('No fue posible completar la solicitud. Verifica tu token e intenta nuevamente.');
        log('ERROR backend.');
        setState_('invalid', (data && typeof data.uses_remaining !== 'undefined') ? data.uses_remaining : undefined);
      }

    }catch(e){
      showERR(e.message || String(e));
      log('ERROR: ' + (e.message || e));
      setState_('neutral');
    }finally{
      setBusy(false);
    }
  }

  Office.onReady(async (info) => {
    const host = (info && info.host) ? info.host : 'unknown';

    if (elHostText) elHostText.textContent = 'host: ' + host;
    elHostDot.className = 'dot green';

    elApiUrl.value = DEFAULT_API_URL;
    setLogVisible_(false);

    const last = await storageGet_('seproincaia.token.last');
    if (last) { elToken.value = last; log('Token cargado desde memoria local.'); }
    else { log('Sin token guardado todavía.'); }

    setState_('neutral');

    btnExecute.addEventListener('click', execute_);
    btnPing.addEventListener('click', ping_);
    btnToggleLog.addEventListener('click', () => setLogVisible_(elLogWrap.classList.contains('logHidden')));

    btnCopyResult.addEventListener('click', copyResult_);
    btnClearResult.addEventListener('click', clearResult_);
    btnToggleTech.addEventListener('click', toggleView_);

    const savedView = await storageGet_('seproincaia.view');
    setView_(savedView === 'tech' ? 'tech' : 'clean');

    let tmr = null;
    elToken.addEventListener('input', () => {
      if (tmr) clearTimeout(tmr);
      tmr = setTimeout(async () => {
        const t = (elToken.value || '').trim();
        if (t) await storageSet_('seproincaia.token.last', t);
        else await storageDel_('seproincaia.token.last');
      }, 350);
    });

    showOK(
      'Listo.\n\n' +
      '• Redactar: párate en la celda de conclusiones (ej. B71:I79) y pulsa Ejecutar.\n' +
      '• Barras: pulsa Ejecutar (lee nombres y llena por nombre).'
    );
    log('Office.onReady OK (host=' + host + ')');
  });

})();
</script>

</body>
</html>
